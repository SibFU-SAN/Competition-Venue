// Данные Зрителя
const accountHesh = 'test1';
let personalSnakeId = accountHesh;

// Данные Игроков: Hesh <=> Name
//const playersHesh = JSON.parse(``);

// Карта Игры
const gameReplay = JSON.parse(`
{"players": ["test1", "test2", "test3", "test4", "test5", "test6", "test7", "test8"], 
"gameSettings": {"height": 40, "weight": 50}, 
"frames": [{"snakes": {"test1": [[31, 3], [32, 3], [32, 2]], "test2": [[4, 17], [2, 17]], "test3": [[26, 36], [26, 38]], "test4": [[46, 35], [48, 35]], "test5": [[31, 36], [31, 38]], "test6": [[41, 36], [41, 38]], "test7": [[21, 4], [21, 2]], "test8": [[4, 21], [2, 21]]}, "apples": []}, {"snakes": {"test1": [[31, 2], [31, 3], [32, 3], [32, 3]], "test2": [[5, 17], [3, 17]], "test3": [[26, 35], [26, 37]], "test4": [[45, 35], [47, 35]], "test5": [[31, 35], [31, 37]], "test6": [[41, 35], [41, 38]], "test7": [[21, 5], [21, 3]], "test8": [[5, 21], [3, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test1": [[32, 2], [31, 2], [31, 3], [32, 3]], "test2": [[6, 17], [4, 17]], "test3": [[26, 34], [26, 36]], "test4": [[44, 35], [46, 35]], "test5": [[31, 34], [31, 36]], "test6": [[41, 34], [41, 37]], "test7": [[21, 6], [21, 4]], "test8": [[6, 21], [4, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test1": [[32, 3], [32, 2], [31, 2], [31, 3], [31, 3]], "test2": [[7, 17], [5, 17]], "test3": [[26, 33], [26, 35]], "test4": [[43, 35], [45, 35]], "test5": [[31, 33], [31, 35]], "test6": [[41, 33], [41, 36]], "test7": [[21, 7], [21, 5]], "test8": [[7, 21], [5, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test2": [[8, 17], [6, 17]], "test3": [[26, 32], [26, 34]], "test4": [[42, 35], [44, 35]], "test5": [[31, 32], [31, 34]], "test6": [[41, 32], [41, 35]], "test7": [[21, 8], [21, 6]], "test8": [[8, 21], [6, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test2": [[9, 17], [7, 17]], "test3": [[26, 31], [26, 33]], "test4": [[41, 35], [43, 35]], "test5": [[31, 31], [31, 33]], "test6": [[41, 31], [41, 34]], "test7": [[21, 9], [21, 7]], "test8": [[9, 21], [7, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test2": [[10, 17], [8, 17]], "test3": [[26, 30], [26, 32]], "test4": [[40, 35], [42, 35]], "test5": [[31, 30], [31, 32]], "test6": [[41, 30], [41, 33]], "test7": [[21, 10], [21, 8]], "test8": [[10, 21], [8, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test2": [[11, 17], [9, 17]], "test3": [[26, 29], [26, 31]], "test4": [[39, 35], [41, 35]], "test5": [[31, 29], [31, 31]], "test6": [[41, 29], [41, 32]], "test7": [[21, 11], [21, 9]], "test8": [[11, 21], [9, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test2": [[12, 17], [10, 17]], "test3": [[26, 28], [26, 30]], "test4": [[38, 35], [40, 35]], "test5": [[31, 28], [31, 30]], "test6": [[41, 28], [41, 31]], "test7": [[21, 12], [21, 10]], "test8": [[12, 21], [10, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test2": [[13, 17], [12, 17]], "test3": [[26, 27], [26, 28]], "test4": [[37, 35], [38, 35]], "test5": [[31, 27], [31, 28]], "test6": [[41, 27], [41, 29]], "test7": [[21, 13], [21, 12]], "test8": [[13, 21], [12, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test2": [[14, 17], [13, 17]], "test3": [[26, 26], [26, 27]], "test4": [[36, 35], [37, 35]], "test5": [[31, 26], [31, 27]], "test6": [[41, 26], [41, 28]], "test7": [[21, 14], [21, 13]], "test8": [[14, 21], [13, 21]]}, "apples": [[40, 14], [15, 33], [31, 23], [24, 2], [22, 35], [2, 5], [13, 11], [27, 37], [1, 18], [40, 28], [25, 0], [21, 20], [15, 40], [34, 23], [8, 16], [11, 15], [19, 22], [4, 37], [1, 25]]}, {"snakes": {"test2": [[15, 17], [14, 17]], "test3": [[26, 25], [26, 26]], "test4": [[35, 35], [36, 35]], "test5": [[31, 25], [31, 26]], "test6": [[41, 25], [41, 27]], "test7": [[21, 15], [21, 14]], "test8": [[15, 21], [14, 21]]}, "apples": [[40, 14], [6, 21], [15, 33], [31, 23], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [21, 20], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test2": [[16, 17], [15, 17]], "test3": [[26, 24], [26, 25]], "test4": [[34, 35], [35, 35]], "test5": [[31, 24], [31, 25]], "test6": [[41, 24], [41, 26]], "test7": [[21, 16], [21, 15]], "test8": [[16, 21], [15, 21]]}, "apples": [[40, 14], [6, 21], [15, 33], [31, 23], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [21, 20], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test2": [[17, 17], [16, 17]], "test3": [[26, 23], [26, 24]], "test4": [[33, 35], [34, 35]], "test5": [[31, 23], [31, 25]], "test6": [[41, 23], [41, 25]], "test7": [[21, 17], [21, 16]], "test8": [[17, 21], [16, 21]]}, "apples": [[40, 14], [6, 21], [15, 33], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [21, 20], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test2": [[18, 17], [17, 17]], "test3": [[26, 22], [26, 23]], "test4": [[32, 35], [33, 35]], "test5": [[31, 22], [31, 24]], "test6": [[41, 22], [41, 24]], "test7": [[21, 18], [21, 17]], "test8": [[18, 21], [17, 21]]}, "apples": [[40, 14], [6, 21], [15, 33], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [21, 20], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test2": [[19, 17], [18, 17]], "test3": [[26, 21], [26, 22]], "test4": [[31, 35], [32, 35]], "test5": [[31, 21], [31, 23]], "test6": [[41, 21], [41, 23]], "test7": [[21, 19], [21, 18]], "test8": [[19, 21], [18, 21]]}, "apples": [[40, 14], [6, 21], [15, 33], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [21, 20], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test2": [[20, 17], [19, 17]], "test3": [[26, 20], [26, 21]], "test4": [[30, 35], [31, 35]], "test5": [[31, 20], [31, 22]], "test6": [[41, 20], [41, 22]], "test7": [[21, 20], [21, 18]], "test8": [[20, 21], [19, 21]]}, "apples": [[40, 14], [6, 21], [15, 33], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test2": [[21, 17], [20, 17]], "test3": [[26, 19], [26, 20]], "test4": [[29, 35], [30, 35]], "test5": [[31, 19], [31, 21]], "test6": [[41, 19], [41, 21]], "test8": [[21, 21], [20, 21]]}, "apples": [[40, 14], [6, 21], [15, 33], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test2": [[22, 17], [21, 17]], "test3": [[26, 18], [26, 19]], "test4": [[28, 35], [29, 35]], "test5": [[31, 18], [31, 20]], "test6": [[41, 18], [41, 20]], "test8": [[22, 21], [21, 21]]}, "apples": [[40, 14], [6, 21], [15, 33], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 17], [31, 18]], "test6": [[41, 17], [41, 18]]}, "apples": [[40, 14], [6, 21], [15, 33], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 16], [31, 17]], "test6": [[41, 16], [41, 17]]}, "apples": [[40, 14], [6, 21], [15, 33], [36, 13], [16, 32], [45, 19], [24, 2], [22, 35], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 37], [1, 18], [8, 36], [12, 3], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [43, 38], [15, 40], [34, 23], [28, 10], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 15], [31, 16]], "test6": [[41, 15], [41, 16]]}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 14], [31, 15]], "test6": [[41, 14], [41, 15]]}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 13], [31, 14]], "test6": [[41, 13], [41, 14]]}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 12], [31, 13]], "test6": [[41, 12], [41, 13]]}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 11], [31, 12]], "test6": [[41, 11], [41, 12]]}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 10], [31, 11]], "test6": [[41, 10], [41, 11]]}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 9], [31, 10]], "test6": [[41, 9], [41, 10]]}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {"test5": [[31, 8], [31, 9]], "test6": [[41, 8], [41, 9]]}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}, {"snakes": {}, "apples": [[40, 14], [13, 30], [10, 37], [6, 21], [14, 4], [15, 33], [36, 13], [16, 32], [45, 19], [23, 37], [24, 2], [22, 35], [43, 3], [2, 5], [17, 30], [13, 11], [36, 37], [0, 17], [27, 38], [19, 15], [27, 37], [1, 18], [29, 1], [8, 36], [48, 23], [12, 3], [12, 6], [23, 12], [40, 28], [20, 19], [34, 30], [25, 0], [17, 23], [11, 10], [34, 37], [43, 38], [47, 2], [21, 4], [26, 31], [29, 27], [15, 40], [34, 23], [29, 33], [28, 10], [22, 30], [37, 22], [8, 16], [46, 6], [11, 6], [33, 6], [7, 11], [11, 15], [19, 22], [42, 30], [4, 37], [30, 37], [1, 25]]}]}
`.replaceAll("&#34;", '"'));

let PlayersColors = new Map();;

// HTML лементы
const canvas  = document.getElementById("game_screen");
const ctx = canvas.getContext('2d');

// Кнопка остановки - запуска
let gameStopped = true;
const btnStop  = document.getElementById("stop");
btnStop.addEventListener("click", stopButtonClick);


console.log(gameReplay);

let frameCount = 0;
let frameStep = 1;
let friendSnake = '#c7737d';
let enemySnake = '#4f4833';


const height = gameReplay.gameSettings.height;
const width = gameReplay.gameSettings.weight;
let step_x = Math.floor(canvas.width / width);
let step_y = Math.floor(canvas.height / height);
	step_x = Math.min(step_x, step_y);
	step_y = step_x;

// Прокрутка видео
let slider = document.getElementById("ReplayRange");
slider.setAttribute("max", gameReplay.frames.length - 1);
slider.oninput = function() {
    frameCount = parseInt(this.value);
	console.log("set value range", frameCount);
	drawFrame(frameCount);
}

// Кнопка reverse
const reverse = document.getElementById("reverse");
reverse.addEventListener("click", reverseButtonClick);

function reverseButtonClick() {
	if (frameStep === 1)
		reverse.value = "normal";
	else
	{
		reverse.value = "reverse";
	}
	frameStep *= -1;
}

// Скорость
let speedSelection = document.getElementById("speed_selection");

function stopButtonClick() {
	if (gameStopped) {
		btnStop.value = "Остановить";
	} else {
		btnStop.value = "Запуск";
	}
	gameStopped = !gameStopped;
}

function drawField() {
	/* Рисуем поле */
	ctx.fillStyle = "#ffffff";
	ctx.fillRect(0, 0, canvas.width, canvas.height);

	// ?
	ctx.strokeStyle = "#bee5ff";
	for (let j = step_x; j < canvas.width; j += step_x) {
		ctx.beginPath();
		ctx.moveTo(j, 0);
		ctx.lineTo(j, canvas.height);
		ctx.closePath();
		ctx.stroke();
	}
	for (let j = step_y; j < canvas.height; j += step_y) {
		ctx.beginPath();
		ctx.moveTo(0, j);
		ctx.lineTo(canvas.width, j);
		ctx.closePath();
		ctx.stroke();
	}
}

function drawFood(x, y) {
	/* Рисуем еду */
	let radius = Math.floor(Math.min(step_x, step_y) / 2);
	ctx.fillStyle = '#00ff00';
	ctx.beginPath();
	ctx.arc((x + 0.5) * step_x, (y + 0.5) * step_y, radius, 0, 2*Math.PI, false);
	ctx.closePath();
	ctx.fill();
}

function drawSnakeElement(x, y) {
	/* Рисуем элемент тела змейки */
	ctx.fillRect(x * step_x, y * step_y, step_x, step_y);
}

function drawSnakeHead(x, y) {
	/* Рисуем гогову змейки */
	ctx.fillRect(x * step_x, y * step_y, step_x, step_y);

	let tempColor = ctx.fillStyle;
	ctx.fillStyle = "#000000";

	ctx.beginPath();
	let radius = Math.floor(Math.min(step_x, step_y) / 2);
	ctx.arc((x + 0.5) * step_x, (y + 0.5) * step_y, radius/2, 0, 2*Math.PI, false);
	ctx.closePath();
	ctx.fill();

	ctx.fillStyle = tempColor;
}

function drawSnake(coordinates) {
	/* Рисуем змейку */
	if (typeof(coordinates[0]) == 'stop')
		return;

    // {"test1": [[8, 8], [3, 6]]}
    let x_min = 0, x_max = 0
    let y_min = 0, y_max = 0

	for (let i = 0; i < coordinates.length - 1; i++)
	{
	    x_min = Math.min(coordinates[i][0], coordinates[i+1][0])
	    x_max = Math.max(coordinates[i][0], coordinates[i+1][0])
	    y_min = Math.min(coordinates[i][1], coordinates[i+1][1])
	    y_max = Math.max(coordinates[i][1], coordinates[i+1][1])
	 
	    for (let x = x_min; x <= x_max; x++)
            for (let y = y_min; y <= y_max; y++)
            {
		        drawSnakeElement(x , gameReplay.gameSettings.height - y - 1);
		    }
    }
    drawSnakeHead(coordinates[0][0], gameReplay.gameSettings.height -  coordinates[0][1] - 1)

}


function drawGame() {
	/* Отрисовка одного кадра игры */
	if (gameStopped) return;
	
	drawFrame(frameCount);
	
	if ((frameCount == gameReplay.frames.length - 1 && frameStep == 1) ||
		(frameCount == 0 && frameStep == -1))
	{
		if (gameStopped == false && (frameCount == gameReplay.frames.length - 1 && frameStep == 1))
			frameCount = 0;
		console.log("end");
		stopButtonClick();
		return;
	}

	frameCount += frameStep;
}

function main() {
	canvas.width = width * step_x;
	canvas.height = height * step_y;
	document.getElementById("info_number").innerHTML = `${Object.keys(gameReplay.players).length}`;
	document.getElementById("info_map").innerHTML = `${gameReplay.gameSettings.weight}x${gameReplay.gameSettings.height}`;
	
	for (let i of gameReplay.players)
	{
		if (i != personalSnakeId)
			PlayersColors.set(i, randColor());
	}
		
	drawField();
	drawFrame(0);

	let timerId  = setTimeout(function timer() {
		drawGame();
		timerId  = setTimeout(timer, 500 / parseFloat(speedSelection.value));
		}, 500 / parseFloat(speedSelection.value));
}

main();

function drawFrame (numberFrame)
{
	let currentFrame = gameReplay.frames[numberFrame];
	document.getElementById("ReplayRange").value = numberFrame;

	drawField();

	for (let apple of currentFrame.apples)
		if (apple.length === 2)
			drawFood(apple[0], gameReplay.gameSettings.height - apple[1] - 1);
		else
			console.log(`Ошибка. Корд яблока - ${apple}`);

	let isFriend = null;
	for (let snake in currentFrame.snakes) 
	{
		isFriend = snake === personalSnakeId;
		
		if (isFriend)
			ctx.fillStyle = friendSnake;
		else
			ctx.fillStyle = PlayersColors.get(snake);
		drawSnake(currentFrame.snakes[snake]);
	}
}

function randColor() {
	const max = 225, 
		  min = 128;
			
    var r = Math.floor(Math.random() * (max - min - 10) + min),
        g = Math.floor(Math.random() * (max - min - 10) + min),
        b = Math.floor(Math.random() * (max - min - 10) + min);
    return '#' + r.toString(16) + g.toString(16) + b.toString(16);
}
